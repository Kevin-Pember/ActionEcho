(()=>{let e={current:{actionSet:void 0,port:void 0,tab:void 0,actionPacket:void 0,editor:void 0},portArray:[],currentEditor:void 0,siteCache:void 0,uiLink:void 0,promisePorts:{tabs:[],push:t=>{e.promisePorts.tabs.push(t)},resolveTarget:t=>{let o,r=e.promisePorts.tabs.find(((e,r)=>{if(t.name==e.url)return o=r,!0}));r&&(r.resolve(t),e.promisePorts.tabs.splice(o,1))}},openTab:t=>(console.log("open tab"),new Promise(((o,r)=>{let s=e.portArray.find((e=>e.name==t));s?(chrome.tabs.update(s.tabId,{active:!0},(e=>{})),o(s)):(chrome.tabs.create({url:t,active:!0},(function(e){})),e.promisePorts.push({url:t,resolve:o,reject:r}))}))),openURL:(t,o)=>new Promise(((r,s)=>{t.postMessage({action:"setURL",url:o}),e.promisePorts.push({url:o,resolve:r,reject:s})})),disconnectPort:t=>{t.disconnected=!0;let r=e.portArray.findIndex((e=>e.tabId==t.tabId));e.portArray.splice(r,1),0==e.portArray.length?e.current.port=void 0:e.current.port==t&&(console.log("this is a test"),console.log(e.portArray[r]),o.setCurrentPort(e.portArray[r])),t.editorActive&&e.closeEditor(),t.disconnected||t.disconnect(),console.log(e.current.editor)}},t={templates:{actionPacket:{v:1,site:void 0,action:"actionPacket",actions:[]}},runActions:async o=>{console.log("running actions (background)"),t.getPackets(o).forEach((async t=>{let o=t.site;o.autoLoad||"url"!=o.format?await e.openTab(o.url):e.current.port&&await e.openURL(e.current.port,o.url),e.current.port.postMessage(t)}))},getUrls:e=>{let t=[];for(let o of e)"site"!=o.type||t.includes(o.url)||t.push(o.url);return t},getPackets:e=>{let o=e.filter((e=>"site"==e.type));console.log(o);let r=[];return o.forEach(((s,a)=>{let c=structuredClone(t.templates.actionPacket);c.actions=e.slice(e.indexOf(s)+1,a<o.length-1?e.indexOf(o[a+1]):e.length),c.site=s,r.push(c)})),r}},o={recording:!1,v:1,templates:{actionSet:{v:1,name:"",actions:[]},site:{type:"site",url:"",format:"",autoLoad:!1},textAction:{type:"input",text:"",specifier:""}},history:{edit:[],redo:[]},urlLoad:{loading:!0,loadAction:!1},parseData:{site:{},textAction:{}},startRecord:()=>{o.recording=!0,e.current.actionSet=structuredClone(o.templates.actionSet),e.current.port.postMessage({action:"startRecord"})},stopRecord:()=>{e.current.port.postMessage({action:"stopRecord"}),e.current.actionSet.log="finished",o.resetRecorder(),o.recording=!1},cacheSite:(e,t)=>{o.parseData.site=structuredClone(o.templates.site),o.parseData.site.url=t,"newUrl"==e&&o.recording?(o.parseData.site.autoLoad=o.urlLoad.loadAction,o.parseData.site.format="url"):o.parseData.site.format="tab"},postCacheSite:()=>{o.parseData.site&&(t.getUrls(e.current.actionSet.actions)[-1]!=o.parseData.site.url&&e.current.actionSet.actions.push(o.parseData.site),o.parseData.site=void 0)},setCurrentPort:t=>{o.recording&&(e.current.port&&0==e.current.port.disconnected&&e.current.port.postMessage({action:"stopRecord"}),t.postMessage({action:"startRecord"}),o.resetRecorder()),e.current.port=t},parseLog:t=>{switch(o.postCacheSite(),console.log(t),t.type){case"click":console.log("click log"),console.log(t.textContext),null!=t.textContext&&(o.parseData.textAction.type?o.resetRecorder():o.parseData.textAction=structuredClone(o.templates.textAction),o.parseData.textAction.text=t.textContext,o.parseData.textAction.specifier=t.specifier),t.specifier!==o.parseData.textAction.specifier&&(o.resetRecorder(),o.parseData.textAction.specifier=t.specifier),e.current.actionSet.actions.push(t);break;case"input":console.log("input log"),console.log(o.parseData.textAction),o.inputHandler(t.key,t.selection.split("-")),o.lastTextLog=t;break;case"key":if(console.log("key log"),"undo"==t.key)o.history.edit.length>0&&(o.history.redo.push(o.parseData.textAction.text),o.parseData.textAction.text=o.history.edit.pop());else if("redo"==t.key)o.history.redo.length>0&&(o.history.edit.push(o.parseData.textAction.text),o.parseData.textAction.text=o.history.redo.pop());else if("paste"==t.key)o.inputHandler(t.text,t.selection.split("-"));else if("cut"==t.key){let e=t.selection.split("-");o.history.edit.push(o.parseData.textAction.text),o.parseData.textAction.text=o.parseData.textAction.text.substring(0,e[0])+o.parseData.textAction.text.substring(e[1],o.parseData.textAction.text.length)}else e.current.actionSet.actions.push(t)}o.urlLoad.loading&&(o.urlLoad.loadAction=!0)},inputHandler:(e,t)=>{let r=o.parseData.textAction.text,s=r;if(console.log("input handler with key: "+e+" and range: "+t+"< add to "+r),t[0]>-1&&t[1]>-1&&t[0]<=r.length&&t[1]<=r.length){let a=r.substring(0,t[0]),c=r.substring(t[1],r.length);o.parseData.textAction.text=a+e+c,o.history.edit.push(s)}},resetRecorder:()=>{console.log("reset head"),console.log(o.parseData.textAction),o.parseData.textAction.text&&o.parseData.textAction.text.length>0&&(e.current.actionSet.actions.push(o.parseData.textAction),o.parseData.textAction=structuredClone(o.templates.textAction)),o.history.edit=[],o.history.redo=[]}},r={schedule:{times:[],actionLists:[]},checkTime:()=>{let e=Date.now();for(let t=0;t<r.schedule.times.length;t++)e>=r.schedule.times[t]&&(e-r.schedule.times[t]>1e4?(r.updateSchedule(t,!1),r.removeScheduledAction(t)):(r.completeIndex(t),r.updateSchedule(t,!0),r.removeScheduledAction(t)),t--)},completeIndex:async e=>{let o=r.schedule.actionLists[e].actions;console.log(o),await t.runActions(o)},addSchedule:e=>{r.schedule.actionLists.push(e),r.schedule.times.push(e.date)},updateSchedule:async(t,o)=>{let s=r.schedule.actionLists[t];o?chrome.runtime.sendMessage(e.uiLink.id,{action:"changeSchedule",id:s.id,state:"completed"}):chrome.runtime.sendMessage(e.uiLink.id,{action:"changeSchedule",id:s.id,state:"failed"})},removeScheduledAction:e=>{e>-1&&(r.schedule.actionLists.splice(e,1),r.schedule.times.splice(e,1),r.saveSchedule())},saveSchedule:()=>{chrome.storage.local.set({scheduledEvents:r.schedule.actionLists})}};chrome.alarms.onAlarm.addListener((async e=>{"clockAlarm"===e.name&&r.checkTime()})),(async()=>{await chrome.alarms.get("clockAlarm")||await chrome.alarms.create("clockAlarm",{periodInMinutes:.01})})(),chrome.storage.local.get(["recording"]).then((e=>{o.recording=null!=e.recording&&e.recording})),chrome.storage.local.get(["scheduledEvents"]).then((e=>{if(console.log(e),null!=e.scheduledEvents)for(let t of e.scheduledEvents)r.addSchedule(t)})),chrome.tabs.onUpdated.addListener((function(e,t,r){console.log("Tab Updated"),t.title?(o.urlLoad.loading=!1,o.urlLoad.loadAction=!1):"loading"==t.status&&t.url&&(o.urlLoad.loading=!0)})),chrome.tabs.onActivated.addListener((t=>{console.log("Tab Activated"),chrome.tabs.get(t.tabId,(r=>{if("chrome://newtab/"!=r.url){let s=e.portArray.find((e=>e.tabId==t.tabId));s&&(console.log(`cached new site: ${r.url}`),o.cacheSite("newTab",r.url),o.setCurrentPort(s))}e.current.tab=t.tabId}))})),chrome.runtime.onConnect.addListener((function(t){console.log("Port Connected"),console.log(t),t.onMessage.addListener((function(r){switch(r.action){case"log":o.parseLog(r);break;case"resolve":e.current.actionPacket.resolve(r);break;case"closedEditor":let s=e.current.editor.editPromises.find((e=>e.tabId==t.tabId));s&&(s.resolve(r.actionList),e.current.editor.editPromises.splice(e.current.editor.editPromises.indexOf(s),1));break;case"closeEditor":console.log("messaged to close editor"),e.closeEditor();break;case"testLog":t.postMessage({action:"testCase"})}})),t.onDisconnect.addListener(e.disconnectPort),t.tabId=t.sender.tab.id;let r=0,s=e.portArray.find(((e,o)=>(r=o,e.tabId==t.sender.tab.id)));console.log(s),s&&(console.log("Port replaced: "+s.name),e.current.port==s&&(o.cacheSite("newUrl",s.name),o.setCurrentPort(t),o.recording&&(t.postMessage({action:"startRecord"}),o.resetRecorder())),e.disconnectPort(s,r)),t.tabId==e.current.tab&&(o.cacheSite("newTab",t.name),e.current.port=t),e.portArray.push(t),console.log(e.portArray),console.log("Port Name: "+t.name),e.promisePorts.resolveTarget(t),console.log(e)})),chrome.runtime.onMessage.addListener(((s,a,c)=>{switch(s.action){case"startRecord":o.startRecord(),c({log:"started"});break;case"stopRecord":o.stopRecord(),console.log("stopping record"),console.log(e.current.actionSet),c(e.current.actionSet),console.log("template is now:"),console.log(o.templates.actionSet),e.current.actionSet=structuredClone(o.templates.actionSet);break;case"scheduleActionSet":r.addSchedule(s.set),console.log(s.set),c({log:"added"});break;case"removeScheduledAction":let n=r.schedule.actionLists.findIndex((e=>e.id==s.id));r.removeScheduledAction(n),c({log:"removed"});break;case"runActionSet":t.runActions(s.set.actions);break;case"openEditor":e.current.editor?e.current.editor.id!=s.actionSet.name?c({log:"alreadyOpen"}):c({log:"noAction"}):((async o=>{let r={id:o.actionSet.name,portList:[],editPromises:[]};console.log(o);let s=t.getUrls(o.actionSet.actions);for(let t of s){let a=o.actionSet.actions.splice(o.actionSet.actions.indexOf(t)+1,s.indexOf(t)<s.length-1?o.actionSet.actions.indexOf(s[s.indexOf(t)+1]):o.actionSet.actions.length);console.log("portActions",a),e.openTab(t).then((e=>{r.portList.push(e),e.hasEditor?(e.postMessage({action:"openEditor",actionSet:{name:o.actionSet.name,actions:a}}),e.editorActive=!0):(chrome.scripting.executeScript({target:{tabId:e.tabId},files:["JS/editorUI.js"]}).then((()=>{e.postMessage({action:"openEditor",actionSet:{name:o.actionSet.name,actions:a}})})),e.editorActive=!0,e.hasEditor=!0)}))}e.current.editor=r})(s),c({log:"opened"}));break;case"closeEditor":console.log("close Editor Called"),e.current.editor?(console.log("running close editor"),e.closeEditor().then((e=>{console.log("closed editor finished"),c({log:"closed",actionList:e})}))):c({log:"noEditor"});break;case"testLog":console.log("test log"),c({log:"test"});break;case"init":e.uiLink=a,c({log:"init",lists:r.schedule.actionLists})}return!0}))})();